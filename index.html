<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D Aventuras RPG - Control de Campaña Dinámico</title>
    <style>
        body {
            font-family: 'Times New Roman', serif;
            /* La imagen de fondo probablemente sea una ruta local, la mantengo */
            background-image: url(pngtree-screenshot-of-a-dungeon-layout-with-a-candle-picture-image_2774994.jpg);
            color: #333;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border: 4px solid #8b4513; /* Borde de madera/pergamino */
            box-shadow: 10px 10px 15px rgba(0, 0, 0, 0.5);
        }
        h1 {
            text-align: center;
            color: #4b0082;
            border-bottom: 3px double #8b4513;
            padding-bottom: 10px;
        }
        h2 {
            color: #8b0000;
            margin-top: 30px;
            border-bottom: 1px solid #ccc;
            padding-bottom: 5px;
        }
        /* Estilos de las Fichas de Personaje */
        .players-section, .enemies-section {
            display: flex;
            flex-wrap: wrap; /* Permite que las fichas salten de línea */
            gap: 20px;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px dashed #ccc;
        }
        /* Estilos de Fichas (Personaje y Enemigo) */
        .player-card, .enemy-card {
            border: 2px solid #a0522d;
            padding: 15px;
            width: 300px; /* Ancho fijo para control dinámico */
            background-color: #fffaf0;
            border-radius: 5px;
            position: relative; /* Para el botón de eliminar */
        }
        .enemy-card {
            background-color: #ffeaea; /* Fondo rojizo claro para enemigos */
            border-color: #8b0000;
        }
        .player-card label, .enemy-card label {
            font-weight: bold;
            display: block;
            margin-top: 5px;
        }
        .player-card input[type="text"], .player-card input[type="number"],
        .enemy-card input[type="text"], .enemy-card input[type="number"] {
            width: 90%;
            padding: 3px;
            margin-bottom: 5px;
            border: 1px solid #ccc;
        }

        /* Botón de Eliminar Ficha */
        .remove-card-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: none;
            border: none;
            color: #cc0000;
            font-weight: bold;
            cursor: pointer;
            padding: 5px;
            line-height: 1;
        }

        /* Botón de Agregar Personaje/Enemigo */
        .add-card-btn-container {
            width: 100%;
            text-align: center;
            margin-top: 10px;
            margin-bottom: 20px;
        }
        .add-card-btn {
            background-color: #007bff; /* Azul */
            padding: 10px 20px;
            font-size: 1.1em;
            cursor: pointer;
        }
        .add-card-btn:hover {
            background-color: #0056b3;
        }
        .add-enemy-btn {
            background-color: #8b0000;
        }
        .add-enemy-btn:hover {
            background-color: #640000;
        }

        /* Estilos del Diario y Control de Combate */
        .main-sections {
            display: flex;
            gap: 20px;
            margin-top: 40px;
        }
        .journal-section, .combat-control-section {
            flex: 1;
            border: 1px solid #000;
            padding: 15px;
            background-color: #fcf8e3;
        }
        textarea {
            width: 98%;
            min-height: 250px;
            padding: 10px;
            border: 1px dashed #666;
            font-family: 'Times New Roman', serif;
            font-size: 1em;
        }

        /* Estilos de la Calculadora de PV */
        .pv-calculator {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #8b4513;
            background-color: #fff8e7;
            text-align: center;
        }
        .pv-calculator select, .pv-calculator input[type="number"] {
            padding: 5px;
            margin: 0 10px;
            font-size: 1em;
        }
        .pv-calculator button {
            padding: 8px 15px;
            font-size: 1em;
        }
        .damage-btn {
            background-color: #cc0000;
        }
        .damage-btn:hover {
            background-color: #a30000;
        }
        .heal-btn {
            background-color: #009933;
        }
        .heal-btn:hover {
            background-color: #007328;
        }

        /* Estilos del Lanzador de Dados */
        .dice-roller {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            border: 2px solid black;
            background-color: #e0e0e0;
        }
        .dice-result {
            font-size: 2.5em;
            font-weight: bold;
            color: green;
            margin-top: 15px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Crónicas de la Tierra Olvidada</h1>
    <p>Documento de Campaña Compartido. Por favor, **guarda una copia local** para anotar tus cambios.</p>

    <h2>Fichas de Aventureros</h2>

    <div class="players-section" id="players-section">
        
        <div class="player-card" data-card-type="player" data-card-id="1">
            <button class="remove-card-btn" onclick="removeCard(this)">✖</button>
            <h3>Jugador 1</h3>
            <label for="nombre1">Nombre:</label>
            <input type="text" id="nombre1" class="card-name" value="Kaelen">
            
            <label for="raza1">Raza/Clase:</label>
            <input type="text" id="raza1" value="Guerrero Elfo">

            <label for="pv1">Puntos de Vida (PV):</label>
            <input type="number" id="pv1" class="pv-input" data-card-name-ref="nombre1" value="15" min="0">

            <label for="ca1">Clase de Armadura (CA):</label>
            <input type="number" id="ca1" value="16" min="10">

            <label for="eq1">Equipo/Arma Principal:</label>
            <input type="text" id="eq1" value="Espada Larga y Escudo">
        </div>

        <div class="player-card" data-card-type="player" data-card-id="2">
            <button class="remove-card-btn" onclick="removeCard(this)">✖</button>
            <h3>Jugador 2</h3>
            <label for="nombre2">Nombre:</label>
            <input type="text" id="nombre2" class="card-name" value="Lyra">
            
            <label for="raza2">Raza/Clase:</label>
            <input type="text" id="raza2" value="Pícaro Mediano">

            <label for="pv2">Puntos de Vida (PV):</label>
            <input type="number" id="pv2" class="pv-input" data-card-name-ref="nombre2" value="12" min="0">

            <label for="ca2">Clase de Armadura (CA):</label>
            <input type="number" id="ca2" value="14" min="10">

            <label for="eq2">Equipo/Habilidad Clave:</label>
            <input type="text" id="eq2" value="Herramientas de ladrón">
        </div>

        <div class="player-card" data-card-type="player" data-card-id="3">
            <button class="remove-card-btn" onclick="removeCard(this)">✖</button>
            <h3>Jugador 3</h3>
            <label for="nombre3">Nombre:</label>
            <input type="text" id="nombre3" class="card-name" value="Zydros">
            
            <label for="raza3">Raza/Clase:</label>
            <input type="text" id="raza3" value="Mago Humano">

            <label for="pv3">Puntos de Vida (PV):</label>
            <input type="number" id="pv3" class="pv-input" data-card-name-ref="nombre3" value="10" min="0">

            <label for="ca3">Clase de Armadura (CA):</label>
            <input type="number" id="ca3" value="12" min="10">

            <label for="eq3">Equipo/Hechizo Clave:</label>
            <input type="text" id="eq3" value="Misil Mágico">
        </div>
    </div>
    
    <div class="add-card-btn-container">
        <button class="add-card-btn" onclick="addCard('player')">➕ Agregar Personaje</button>
    </div>

    <hr>
    
    <h2>Fichas de Enemigos y PNJs Clave</h2>

    <div class="enemies-section" id="enemies-section">
        
        <div class="enemy-card" data-card-type="enemy" data-card-id="1">
            <button class="remove-card-btn" onclick="removeCard(this)">✖</button>
            <h3>Enemigo 1</h3>
            <label for="enemigo_name_1">Nombre:</label>
            <input type="text" id="enemigo_name_1" class="card-name" value="Líder Goblin">
            
            <label for="enemigo_type_1">Tipo/Rol:</label>
            <input type="text" id="enemigo_type_1" value="Bestia / Jefe">

            <label for="enemigo_pv_1">Puntos de Vida (PV):</label>
            <input type="number" id="enemigo_pv_1" class="pv-input" data-card-name-ref="enemigo_name_1" value="15" min="0">

            <label for="enemigo_ca_1">Clase de Armadura (CA):</label>
            <input type="number" id="enemigo_ca_1" value="14" min="10">
        </div>
        
    </div>
    
    <div class="add-card-btn-container">
        <button class="add-card-btn add-enemy-btn" onclick="addCard('enemy')">➕ Agregar Enemigo/PNJ</button>
    </div>

    <div class="main-sections">
        <div class="journal-section">
            <h2>Diario de la Campaña (Para el DM o el Anotador)</h2>
            <p>Utiliza este espacio para registrar la historia, los PNJs, las pistas y las misiones activas.</p>
            <textarea id="adventure-journal">
-- DÍA 1: La taberna "El Dragón Dormido" --

El grupo de aventureros se reunió en la ciudad de Puerto Bruma. La posadera, Elara, les ha ofrecido una recompensa de 50 monedas de oro si logran recuperar un anillo familiar que fue robado por Goblins del Bosque Susurrante.

PNJs Importantes:
- Elara (Posadera): Preocupada, tiene una cicatriz en la mano.
- Capitán Borin (Guardia): No cree en las historias de Goblins.

Pistas:
- Los Goblins se dirigen hacia el Este, al viejo molino abandonado.

Misión Actual:
- Recuperar el Anillo de la Familia de Elara del molino abandonado.
            </textarea>
        </div>

        <div class="combat-control-section">
            <h2>Control de Combate y Calculadora</h2>
            <p>Gestión rápida de los Puntos de Vida de **cualquier ficha** (Jugador o Enemigo).</p>
            
            <div class="pv-calculator">
                <label for="pv-target">Ficha a modificar:</label>
                <select id="pv-target"></select>

                <label for="pv-amount">Monto:</label>
                <input type="number" id="pv-amount" value="5" min="1" style="width: 50px;">
                
                <button class="damage-btn" onclick="modifyPV(-1)">Recibir Daño (-)</button>
                <button class="heal-btn" onclick="modifyPV(1)">Sanar/Ganar PV (+)</button>
            </div>

            <h2 style="margin-top: 15px;">Notas de Combate Rápido</h2>
            <p>Usa este espacio para anotar la CA de los enemigos genéricos, condiciones, etc.</p>
            <textarea id="combat-notes" min-height="100px;">
CA Enemigo Genérico: 13 (Goblin)
Condiciones: Kaelen: Bendecido (siguiente ataque con ventaja)
            </textarea>
        </div>
    </div>
    <div class="dice-roller">
        <h2>Lanzador de Dados</h2>
        <p>¡Lanza el dado para ataques, salvaciones o pruebas de habilidad!</p>
        <button onclick="rollDice(4)">Tirar D4</button>
        <button onclick="rollDice(6)">Tirar D6</button>
        <button onclick="rollDice(8)">Tirar D8</button>
        <button onclick="rollDice(10)">Tirar D10</button>
        <button onclick="rollDice(12)">Tirar D12</button>
        <button onclick="rollDice(20)">Tirar D20 (Prueba/Ataque)</button>
        
        <div class="dice-result" id="result">
            Resultado: -
        </div>
    </div>
    
    <script>
        let playerCount = 3; // Contador inicial de jugadores
        let enemyCount = 1; // Contador inicial de enemigos

        // --- Funciones de Dados ---
        function rollDice(sides) {
            const result = Math.floor(Math.random() * sides) + 1;
            const resultElement = document.getElementById('result');
            resultElement.innerHTML = `Tirada de D${sides}: **${result}**`;

            // Lógica de Crítico para el D20
            if (sides === 20) {
                if (result === 20) {
                    resultElement.innerHTML += " **¡Éxito Crítico!**";
                    resultElement.style.color = '#ff6600'; // Naranja
                } else if (result === 1) {
                    resultElement.innerHTML += " **¡Fallo Crítico!**";
                    resultElement.style.color = '#cc0000'; // Rojo
                } else {
                    resultElement.style.color = '#008000'; // Verde
                }
            } else {
                resultElement.style.color = '#008000'; // Verde
            }
        }

        // --- Funciones de Personaje/Enemigo y PV (La Calculadora) ---

        // 1. Inicializa el selector de PV al cargar
        document.addEventListener('DOMContentLoaded', updatePVTargetSelector);
        
        // 2. Escucha cambios en los nombres para actualizar el selector de PV
        document.getElementById('players-section').addEventListener('change', function(e) {
            if (e.target.classList.contains('card-name')) {
                updatePVTargetSelector();
            }
        });
        document.getElementById('enemies-section').addEventListener('change', function(e) {
            if (e.target.classList.contains('card-name')) {
                updatePVTargetSelector();
            }
        });


        /**
         * Modifica los Puntos de Vida de una ficha (personaje o enemigo) seleccionada.
         * Esta es la función central de la "calculadora".
         * @param {number} modifier - 1 para sanación/aumento, -1 para daño/reducción.
         */
        function modifyPV(modifier) {
            const targetId = document.getElementById('pv-target').value;
            const amountInput = document.getElementById('pv-amount');
            const amount = parseInt(amountInput.value);
            const targetInput = document.getElementById(targetId);
            
            if (!targetInput || isNaN(amount) || amount <= 0) {
                alert("Por favor, selecciona una ficha y un monto válido.");
                return;
            }

            let currentPV = parseInt(targetInput.value);
            let newPV;
            let logMessage;

            if (modifier > 0) {
                // Sanación/Incremento
                newPV = currentPV + amount;
                logMessage = `+${amount} PV a ${targetInput.dataset.cardName} (PV actual: ${newPV})`;
            } else {
                // Daño/Decremento
                newPV = currentPV - amount;
                if (newPV < 0) newPV = 0; // PV no pueden ser negativos
                logMessage = `-${amount} PV de DAÑO a ${targetInput.dataset.cardName} (PV actual: ${newPV})`;
            }

            targetInput.value = newPV;
            targetInput.focus();

            // Opcional: registrar el evento en las notas de combate
            const combatNotes = document.getElementById('combat-notes');
            combatNotes.value += `\n[${new Date().toLocaleTimeString()}] ${logMessage}`;
            combatNotes.scrollTop = combatNotes.scrollHeight; // Desplazar al final
        }

        /**
         * Genera la ficha HTML base para un nuevo personaje o enemigo.
         * @param {string} type - 'player' o 'enemy'.
         * @param {number} id - El ID numérico.
         * @returns {string} El HTML de la nueva ficha.
         */
        function createCardHTML(type, id) {
            const isPlayer = type === 'player';
            const cardClass = isPlayer ? 'player-card' : 'enemy-card';
            const title = isPlayer ? `Jugador ${id}` : `Enemigo ${id}`;
            const nameId = isPlayer ? `nombre${id}` : `enemigo_name_${id}`;
            const pvId = isPlayer ? `pv${id}` : `enemigo_pv_${id}`;
            const caId = isPlayer ? `ca${id}` : `enemigo_ca_${id}`;
            const otherLabel = isPlayer ? 'Raza/Clase:' : 'Tipo/Rol:';
            const otherId = isPlayer ? `raza${id}` : `enemigo_type_${id}`;
            const otherValue = isPlayer ? 'Clase por Defecto' : 'Tipo por Defecto';
            const extraField = isPlayer ? 
                `<label for="eq${id}">Equipo/Habilidad Clave:</label><input type="text" id="eq${id}" value="Equipo Básico">` : 
                '';

            return `
                <div class="${cardClass}" data-card-type="${type}" data-card-id="${id}">
                    <button class="remove-card-btn" onclick="removeCard(this)">✖</button>
                    <h3>${title}</h3>
                    <label for="${nameId}">Nombre:</label>
                    <input type="text" id="${nameId}" class="card-name" value="${isPlayer ? 'Nuevo Héroe' : 'Nuevo Enemigo'}">
                    
                    <label for="${otherId}">${otherLabel}</label>
                    <input type="text" id="${otherId}" value="${otherValue}">

                    <label for="${pvId}">Puntos de Vida (PV):</label>
                    <input type="number" id="${pvId}" class="pv-input" data-card-name-ref="${nameId}" value="10" min="0">

                    <label for="${caId}">Clase de Armadura (CA):</label>
                    <input type="number" id="${caId}" value="10" min="10">
                    ${extraField}
                </div>
            `;
        }
        
        /**
         * Añade dinámicamente una nueva ficha de personaje o enemigo.
         * @param {string} type - 'player' o 'enemy'.
         */
        function addCard(type) {
            let id;
            let section;

            if (type === 'player') {
                playerCount++;
                id = playerCount;
                section = document.getElementById('players-section');
            } else {
                enemyCount++;
                id = enemyCount;
                section = document.getElementById('enemies-section');
            }
            
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = createCardHTML(type, id).trim();
            
            section.appendChild(tempDiv.firstChild);

            updatePVTargetSelector();
        }

        /**
         * Elimina una ficha (personaje o enemigo) y actualiza el selector de PV.
         * @param {HTMLElement} button - El botón de eliminar (✖).
         */
        function removeCard(button) {
            if (confirm("¿Estás seguro de que quieres eliminar esta ficha?")) {
                const card = button.closest('.player-card, .enemy-card');
                card.remove();
                updatePVTargetSelector();
            }
        }

        /**
         * Actualiza el selector de PV en la calculadora con todas las fichas activas.
         */
        function updatePVTargetSelector() {
            const selector = document.getElementById('pv-target');
            selector.innerHTML = ''; // Limpiar opciones existentes
            
            // Recorre todos los inputs de PV
            const pvInputs = document.querySelectorAll('.pv-input');

            pvInputs.forEach(pvInput => {
                const pvId = pvInput.id;
                
                // Obtener la referencia al input del nombre
                const nameInputId = pvInput.dataset.cardNameRef;
                const nameInput = document.getElementById(nameInputId);
                
                // Determinar el nombre a mostrar
                const name = nameInput ? (nameInput.value || `Ficha ID: ${pvId}`) : pvId;

                // Añadir el nombre al dataset del input de PV para usarlo en modifyPV
                pvInput.dataset.cardName = name;

                const option = document.createElement('option');
                option.value = pvId;
                option.textContent = name;
                selector.appendChild(option);
            });
            
            // Si no hay fichas, añade una opción por defecto
            if (pvInputs.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = '--- No hay fichas ---';
                selector.appendChild(option);
            }
        }
        
    </script>
</div>

</body>
</html>